import os
import numpy as np
import torch

def world2image(traj_w, H_inv):
    # Converts points from Euclidean to homogeneous space, by (x, y) â†’ (x, y, 1)
    a = np.ones((traj_w.shape[0], 1))
    traj_homog = np.hstack((traj_w, np.ones((traj_w.shape[0], 1)))).T
    # to camera frame
    traj_cam = np.matmul(H_inv, traj_homog)
    # to pixel coords
    traj_uvz = np.transpose(traj_cam/traj_cam[2])
    return traj_uvz[:, :2].astype(int)

H = np.loadtxt("h.txt")
H_inv = np.linalg.inv(H)
traj = torch.tensor([[[ 8.5248,  4.5612],
         [ 8.3175,  3.9781],
         [ 6.8242,  5.8889],
         [ 4.6149,  3.8141],
         [ 9.5251,  6.2162],
         [10.0674,  5.4462]],

        [[ 8.0766,  4.5823],
         [ 7.8642,  4.0449],
         [ 7.3315,  5.8186],
         [ 5.1467,  3.6388],
         [ 9.1594,  6.3296],
         [ 9.6301,  5.5407]],

        [[ 7.6242,  4.6194],
         [ 7.4120,  4.1197],
         [ 7.8508,  5.7503],
         [ 5.6871,  3.4776],
         [ 8.8000,  6.4379],
         [ 9.1959,  5.6370]],

        [[ 7.1729,  4.6663],
         [ 6.9633,  4.1986],
         [ 8.3770,  5.6857],
         [ 6.2296,  3.3310],
         [ 8.4477,  6.5414],
         [ 8.7657,  5.7331]],

        [[ 6.7286,  4.7180],
         [ 6.5217,  4.2788],
         [ 8.9100,  5.6277],
         [ 6.7760,  3.1989],
         [ 8.1041,  6.6413],
         [ 8.3424,  5.8281]],

        [[ 6.2919,  4.7724],
         [ 6.0879,  4.3594],
         [ 9.4477,  5.5769],
         [ 7.3278,  3.0798],
         [ 7.7691,  6.7386],
         [ 7.9266,  5.9220]],

        [[ 5.8614,  4.8282],
         [ 5.6606,  4.4397],
         [ 9.9873,  5.5329],
         [ 7.8848,  2.9722],
         [ 7.4414,  6.8340],
         [ 7.5175,  6.0147]],

        [[ 5.4355,  4.8844],
         [ 5.2383,  4.5192],
         [10.5266,  5.4944],
         [ 8.4453,  2.8745],
         [ 7.1193,  6.9273],
         [ 7.1136,  6.1057]],

        [[ 5.0125,  4.9404],
         [ 4.8193,  4.5974],
         [11.0642,  5.4599],
         [ 9.0070,  2.7853],
         [ 6.8011,  7.0183],
         [ 6.7133,  6.1949]],

        [[ 4.5909,  4.9957],
         [ 4.4023,  4.6739],
         [11.5994,  5.4278],
         [ 9.5679,  2.7029],
         [ 6.4851,  7.1068],
         [ 6.3150,  6.2819]],

        [[ 4.1698,  5.0500],
         [ 3.9860,  4.7486],
         [12.1319,  5.3965],
         [10.1265,  2.6257],
         [ 6.1698,  7.1927],
         [ 5.9176,  6.3666]],

        [[ 3.7483,  5.1032],
         [ 3.5695,  4.8214],
         [12.6616,  5.3646],
         [10.6819,  2.5518],
         [ 5.8541,  7.2758],
         [ 5.5201,  6.4490]]])

converted_traj = []
for tra in traj:
    a = world2image(tra, H_inv)
    converted_traj.append(a)

b = np.asarray(converted_traj)
print(b)
for a in range(5):
    lst2 = [item[a] for item in b]
    lt = np.asarray(lst2)
    print(lt[:, 0])
    print(lt[:, 1])