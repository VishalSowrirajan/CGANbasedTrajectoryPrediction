import os
import numpy as np
import torch

def world2image(traj_w, H_inv):
    # Converts points from Euclidean to homogeneous space, by (x, y) â†’ (x, y, 1)
    a = np.ones((traj_w.shape[0], 1))
    traj_homog = np.hstack((traj_w, np.ones((traj_w.shape[0], 1)))).T
    # to camera frame
    traj_cam = np.matmul(H_inv, traj_homog)
    # to pixel coords
    traj_uvz = np.transpose(traj_cam/traj_cam[2])
    return traj_uvz[:, :2].astype(int)

H = np.loadtxt("hotel_h.txt")
H_inv = np.linalg.inv(H)
traj = torch.tensor([[[ 0.8515, -0.0486],
         [ 0.3392,  0.2029],
         [ 1.2510, -0.3234],
         [ 0.2464, -0.0324]],

        [[ 0.8509, -0.5045],
         [ 0.3869, -0.2360],
         [ 1.5006, -0.7467],
         [ 0.2315, -0.4902]],

        [[ 0.8577, -0.9800],
         [ 0.4536, -0.6930],
         [ 1.7732, -1.1302],
         [ 0.2478, -0.9666]],

        [[ 0.8581, -1.4763],
         [ 0.5230, -1.1689],
         [ 2.0631, -1.5033],
         [ 0.2859, -1.4622]],

        [[ 0.8449, -1.9838],
         [ 0.5842, -1.6545],
         [ 2.3625, -1.8645],
         [ 0.3337, -1.9643]],

        [[ 0.8177, -2.4997],
         [ 0.6318, -2.1487],
         [ 2.6682, -2.2175],
         [ 0.3804, -2.4707]],

        [[ 0.7790, -3.0227],
         [ 0.6629, -2.6540],
         [ 2.9778, -2.5661],
         [ 0.4176, -2.9837]],

        [[ 0.7317, -3.5498],
         [ 0.6756, -3.1714],
         [ 3.2897, -2.9124],
         [ 0.4398, -3.5047]],

        [[ 0.6773, -4.0766],
         [ 0.6708, -3.6994],
         [ 3.6023, -3.2579],
         [ 0.4457, -4.0332]],

        [[ 0.6151, -4.5978],
         [ 0.6515, -4.2346],
         [ 3.9144, -3.6032],
         [ 0.4362, -4.5663]],

        [[ 0.5433, -5.1090],
         [ 0.6212, -4.7719],
         [ 4.2253, -3.9493],
         [ 0.4129, -5.0995]],

        [[ 0.4602, -5.6062],
         [ 0.5810, -5.3062],
         [ 4.5344, -4.2965],
         [ 0.3763, -5.6280]]])

converted_traj = []
for tra in traj:
    a = world2image(tra, H_inv)
    converted_traj.append(a)

b = np.asarray(converted_traj)
print(b)